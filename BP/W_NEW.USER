PROGRAM W_NEW.USER
** INFORMATION ****************************************************************
*   Routine Name : W_NEW.USER
*           Type : PROGRAM
*         Params :
*            Loc : BP
** AUDIT **********************************************************************
*   Info Updated : 20210322 at 09.54.55 in DEV by root
*                : on mercury.local (Mac)
*******************************************************************************

$INSERT BP I_UTIL.H
$INSERT BP I_HTTP.H
$INSERT BP F_WEB.CREDENTIALS.H
$INSERT BP F_WEB.CREDENTIALS.IDX.H

   PN=SYSTEM(45)
   CALL U_INITIALISE(PN)
   CALL U_START(PN)
   CALL U_HEADER(PN)

   FV.WEB.CREDENTIALS = "" ; CALL U_IO.OPENFILE(W$CRED.FILENAME, FV.WEB.CREDENTIALS, @TRUE, "")
   FV.WEB.CREDENTIALS.IDX = "" ; CALL U_IO.OPENFILE(W$CRED_IDX.FILENAME, FV.WEB.CREDENTIALS.IDX, @TRUE, "")

   sessionPasswordLife = "" ; CALL U_IO.GET.PROPERTY("wct_connect", "sessionPasswordLife", sessionPasswordLife)
   sessionPasswordLife = sessionPasswordLife * 86400  ;* No Seconds in Day

   R.WEB.CREDENTIALS = "" ; R.WEB.CREDENTIALS.IDX = ""
   RESPONSE = ""
   CALL U_INPUT(W$CRED.USERNAME$LABEL, W$CRED.USERNAME$LEN, W$CRED.USERNAME$MASK, @TRUE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.USERNAME> = RESPONSE
   CALL U_INPUT(W$CRED.PASSWORD$LABEL, W$CRED.PASSWORD$LEN, W$CRED.PASSWORD$MASK, @TRUE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.PASSWORD> = RESPONSE
   CALL U_INPUT(W$CRED.FIRSTNAME$LABEL, W$CRED.FIRSTNAME$LEN, W$CRED.FIRSTNAME$MASK, @FALSE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.FIRSTNAME> = RESPONSE
   CALL U_INPUT(W$CRED.LASTNAME$LABEL, W$CRED.LASTNAME$LEN, W$CRED.LASTNAME$MASK, @FALSE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.LASTNAME> = RESPONSE
   KNOWNAS.MAND = @FALSE ; IF R.WEB.CREDENTIALS<W$CRED.FIRSTNAME> = "" THEN KNOWNAS.MAND = @TRUE
   CALL U_INPUT(W$CRED.KNOWNAS$LABEL, W$CRED.KNOWNAS$LEN, W$CRED.KNOWNAS$MASK, KNOWNAS.MAND, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.KNOWNAS> = RESPONSE
   CALL U_INPUT(W$CRED.EMAIL$LABEL, W$CRED.EMAIL$LEN, W$CRED.EMAIL$MASK, @TRUE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.EMAIL> = RESPONSE
   CALL U_INPUT(W$CRED.ROLE$LABEL, W$CRED.ROLE$LEN, W$CRED.ROLE$MASK, @TRUE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.ROLE> = RESPONSE
   CALL U_INPUT(W$CRED.BRAND$LABEL, W$CRED.BRAND$LEN, W$CRED.BRAND$MASK, @TRUE, RESPONSE) ; R.WEB.CREDENTIALS<W$CRED.BRAND> = RESPONSE

   THIS.TIME = EPOCH()

   R.WEB.CREDENTIALS<W$CRED.ISSUED> = THIS.TIME
   R.WEB.CREDENTIALS<W$CRED.EXPIRY> = THIS.TIME + sessionPasswordLife
   R.WEB.CREDENTIALS<W$CRED.MACHINE> = SYSTEM(1015)
   ID.WEB.CREDENTIALS = DOWNCASE(SYSTEM(1047))[1, 8]

   ID.WEB.CREDENTIALS.IDX = R.WEB.CREDENTIALS<W$CRED.USERNAME>
   R.WEB.CREDENTIALS.IDX<W$CRED_IDX.ID> = ID.WEB.CREDENTIALS

   CALL U_CRT.INFO(W$CRED.USERNAME$LABEL, R.WEB.CREDENTIALS<W$CRED.USERNAME>)
   CALL U_CRT.INFO("ID", ID.WEB.CREDENTIALS)
   CALL U_CRT.INFO(W$CRED.ISSUED$LABEL, OCONV(R.WEB.CREDENTIALS<W$CRED.ISSUED>, W$CRED.ISSUED$MASK))
   CALL U_CRT.INFO(W$CRED.EXPIRY$LABEL, OCONV(R.WEB.CREDENTIALS<W$CRED.EXPIRY>, W$CRED.EXPIRY$MASK))

   CALL U_IO.WRITE(FV.WEB.CREDENTIALS, ID.WEB.CREDENTIALS, R.WEB.CREDENTIALS, @TRUE, "")
   CALL U_IO.WRITE(FV.WEB.CREDENTIALS.IDX, ID.WEB.CREDENTIALS.IDX, R.WEB.CREDENTIALS.IDX, @TRUE, "")


   CALL U_STOP(PN)
   STOP
END
